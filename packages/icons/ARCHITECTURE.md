# `@charcoal-ui/icons` の設計

## SVG が表示されるまで

`<pixiv-icon>` は Custom Elements です。

したがって、SVG の取得をはじめ全ての処理はクライアントサイドでのみ走ります。

`<pixiv-icon>` を含むマークアップは Server Side Rendering したときも壊れないように動く必要がありますが、ブラウザの初回ロード時には SVG はまだ読み込まれません。

`<pixiv-icon>` は要素が画面内に表示されたタイミングで SVG をリクエストし、SVG 文字列をそのまま Shadow Root に挿入します。

以降、属性（特にアイコン名やサイズ）が変化するまでは再取得は走りません。

## 収録アイコンとカスタムアイコン

`<pixiv-icon>` には charcoal が予め収録しているアイコンに加え、プロジェクトに特有のアイコンを登録することが出来ます。

予め収録しているアイコンは `@charcoal-ui/icon-files` という別の npm パッケージで配布されており、`<pixiv-icon>` はこの中の SVG を dynamic import します。

ただし、`*.svg` ファイルをそのまま `import()` すると挙動が各プロジェクトのバンドラに依存してしまうため、`@charcoal-ui/icon-files` は SVG を JavaScript の文字列として（ `*.js` のファイルから）提供しています。

カスタムアイコンは、利用しているプロダクト内のファイルパスまたは `*.svg` の URL を渡せます。こちらは各プロジェクトのバンドラに依存していて構いません。

## Loader について

収録アイコンとカスタムアイコンでは SVG の読み込み手法が全く異なります。これらの分岐を可能にする仕組みが `Loader` と呼ばれるオブジェクトです。

`@charcoal-ui/icons` における `Loader` とは、`fetch(): Promise<string>` を実装し、またライブラリ内のオブジェクトプールにキャッシュされたオブジェクトを指します。
このオブジェクトプールがあることで、一度取得されたアイコンはキャッシュされ、再度取得されるということがなくなります。
